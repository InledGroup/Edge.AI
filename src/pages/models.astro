---
import PageLayout from "@/components/landing/PageLayout.astro";
import { getVisibleChatModels } from "@/lib/ai/model-registry";
import { getLanguageFromURL } from "@/lib/i18n";

const lang = getLanguageFromURL(Astro.url);

const translations = {
  es: {
    title: "Todos los modelos",
    subtitle:
      "Selecciona un modelo para ver sus características y comenzar a usarlo.",
    cta: "Probar",
    size: "Tamaño",
    memory: "RAM",
    context: "Contexto",
  },
  en: {
    title: "All Models",
    subtitle: "Select a model to see its features and start using it.",
    cta: "Try",
    size: "Size",
    memory: "RAM",
    context: "Context",
  },
};

const t = translations[lang as keyof typeof translations] || translations.en;
const models = getVisibleChatModels();

const groupedModels = {
  small: models.filter((m) => m.sizeGB < 1),
  medium: models.filter((m) => m.sizeGB >= 1 && m.sizeGB < 3),
  large: models.filter((m) => m.sizeGB >= 3),
};

const groupLabels = {
  small: lang === "es" ? "Pequeños (< 1GB)" : "Small (< 1GB)",
  medium: lang === "es" ? "Medianos (1-3GB)" : "Medium (1-3GB)",
  large: lang === "es" ? "Grandes (> 3GB)" : "Large (> 3GB)",
};

function getModelUrl(id: string) {
  return `/${lang === "es" ? "modelo" : "model"}/${id}`;
}
---

<PageLayout lang={lang} title={t.title}>
  <script is:inline define:vars={{ translations }}>
    (function () {
      const urlParams = new URLSearchParams(window.location.search);
      const urlLang =
        urlParams.get("lang") || localStorage.getItem("edgeai-lang") || "en";
      const currentHtmlLang = document.documentElement.lang;

      if (urlLang !== currentHtmlLang) {
        const t = translations[urlLang] || translations.en;

        const updateText = (selector, text) => {
          const el = document.querySelector(selector);
          if (el) el.textContent = text;
        };

        updateText(".page-title", t.title);
        updateText(".page-subtitle", t.subtitle);

        document.querySelectorAll(".spec-label").forEach((el) => {
          if (
            el.textContent === translations.en.size ||
            el.textContent === translations.es.size
          )
            el.textContent = t.size;
          if (
            el.textContent === translations.en.memory ||
            el.textContent === translations.es.memory
          )
            el.textContent = t.memory;
          if (
            el.textContent === translations.en.context ||
            el.textContent === translations.es.context
          )
            el.textContent = t.context;
        });

        document.querySelectorAll(".model-cta span").forEach((el) => {
          el.textContent = t.cta + " →";
        });

        document.querySelectorAll(".tag.recommended").forEach((el) => {
          el.textContent = urlLang === "es" ? "Recomendado" : "Recommended";
        });

        const groupTitles = document.querySelectorAll(".group-title");
        groupTitles.forEach((el) => {
          if (
            el.textContent.includes("Small") ||
            el.textContent.includes("Pequeños")
          )
            el.textContent =
              urlLang === "es" ? "Pequeños (< 1GB)" : "Small (< 1GB)";
          if (
            el.textContent.includes("Medium") ||
            el.textContent.includes("Medianos")
          )
            el.textContent =
              urlLang === "es" ? "Medianos (1-3GB)" : "Medium (1-3GB)";
          if (
            el.textContent.includes("Large") ||
            el.textContent.includes("Grandes")
          )
            el.textContent =
              urlLang === "es" ? "Grandes (> 3GB)" : "Large (> 3GB)";
        });
      }
    })();
  </script>
  <div class="models-page">
    <header class="page-header">
      <h1 class="page-title">{t.title}</h1>
      <p class="page-subtitle">{t.subtitle}</p>
    </header>

    {
      Object.entries(groupedModels).map(
        ([group, groupModels]) =>
          groupModels.length > 0 && (
            <section class="model-group">
              <h2 class="group-title">
                {groupLabels[group as keyof typeof groupLabels]}
              </h2>
              <div class="models-grid">
                {groupModels.map((model) => (
                  <a href={getModelUrl(model.id)} class="model-card">
                    <div class="model-header">
                      <h3 class="model-name">{model.displayName}</h3>
                      <div class="model-tags">
                        {model.tags.includes("recommended") && (
                          <span class="tag recommended">
                            {lang === "es" ? "Recomendado" : "Recommended"}
                          </span>
                        )}
                        {model.requiresWebGPU && (
                          <span class="tag gpu">GPU</span>
                        )}
                      </div>
                    </div>
                    <p class="model-desc">{model.description}</p>
                    <div class="model-specs">
                      <div class="spec">
                        <span class="spec-label">{t.size}</span>
                        <span class="spec-value">{model.sizeGB} GB</span>
                      </div>
                      <div class="spec">
                        <span class="spec-label">{t.memory}</span>
                        <span class="spec-value">{model.minMemoryGB} GB</span>
                      </div>
                      <div class="spec">
                        <span class="spec-label">{t.context}</span>
                        <span class="spec-value">
                          {model.contextSize / 1000}k
                        </span>
                      </div>
                    </div>
                    <div class="model-cta">
                      <span>{t.cta} →</span>
                    </div>
                  </a>
                ))}
              </div>
            </section>
          ),
      )
    }
  </div>
</PageLayout>

<style>
  .models-page {
    padding: 7rem 1rem 4rem;
    max-width: 1100px;
    margin: 0 auto;
  }

  .page-header {
    text-align: center;
    margin-bottom: 3rem;
  }

  .page-title {
    font-size: 2.5rem;
    font-weight: 800;
    margin-bottom: 0.75rem;
    letter-spacing: -0.02em;
  }

  .page-subtitle {
    font-size: 1.125rem;
    color: var(--color-text-secondary);
  }

  .model-group {
    margin-bottom: 3rem;
  }

  .group-title {
    font-size: 1.25rem;
    font-weight: 700;
    margin-bottom: 1.25rem;
    padding-bottom: 0.75rem;
    border-bottom: 1px solid var(--color-border);
  }

  .models-grid {
    display: grid;
    grid-template-columns: 1fr;
    gap: 1rem;
  }

  @media (min-width: 640px) {
    .models-grid {
      grid-template-columns: repeat(2, 1fr);
    }
  }

  @media (min-width: 900px) {
    .models-grid {
      grid-template-columns: repeat(3, 1fr);
    }
  }

  .model-card {
    display: flex;
    flex-direction: column;
    padding: 1.25rem;
    background: var(--color-bg-secondary);
    border: 1px solid var(--color-border);
    border-radius: 1rem;
    transition: all 0.3s ease;
  }

  .model-card:hover {
    border-color: var(--color-primary);
    transform: translateY(-4px);
    box-shadow: 0 10px 30px rgba(40, 229, 24, 0.1);
  }

  .model-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 0.75rem;
  }

  .model-name {
    font-size: 1rem;
    font-weight: 700;
    line-height: 1.3;
  }

  .model-tags {
    display: flex;
    gap: 0.375rem;
  }

  .tag {
    padding: 0.125rem 0.5rem;
    border-radius: 9999px;
    font-size: 0.625rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.03em;
  }

  .tag.recommended {
    background: rgba(40, 229, 24, 0.15);
    color: var(--color-primary);
  }

  .tag.gpu {
    background: rgba(59, 130, 246, 0.15);
    color: #3b82f6;
  }

  .model-desc {
    font-size: 0.8125rem;
    color: var(--color-text-secondary);
    line-height: 1.5;
    flex: 1;
    margin-bottom: 1rem;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  .model-specs {
    display: flex;
    gap: 1rem;
    padding-top: 0.75rem;
    border-top: 1px solid var(--color-border);
    margin-bottom: 0.75rem;
  }

  .spec {
    display: flex;
    flex-direction: column;
  }

  .spec-label {
    font-size: 0.625rem;
    color: var(--color-text-tertiary);
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }

  .spec-value {
    font-size: 0.8125rem;
    font-weight: 600;
    color: var(--color-text);
  }

  .model-cta {
    font-size: 0.875rem;
    font-weight: 600;
    color: var(--color-primary);
    transition: gap 0.2s ease;
  }

  .model-card:hover .model-cta {
    gap: 0.5rem;
  }
</style>
